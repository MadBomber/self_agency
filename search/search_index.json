{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"`/]+|\\.(?!\\d)|&[lg]t;|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Overview","text":"SelfAgency   Describe what you want in plain language, get working methods back.   SelfAgency is a mixin module that gives any Ruby class the ability to   generate and install methods at runtime via an LLM. Key Features <ul> <li>Natural language to Ruby methods \u2014 describe what you want, get working code</li> <li>Multiple methods at once \u2014 generate related methods in a single call</li> <li>Three scopes \u2014 instance, singleton, and class methods</li> <li>Two-stage LLM pipeline \u2014 shape the prompt, then generate code</li> </ul> <ul> <li>Security by default \u2014 static analysis + runtime sandbox</li> <li>Source inspection \u2014 view generated code with <code>_source_for</code></li> <li>Save to files \u2014 persist as subclasses with <code>_save!</code></li> <li>Provider agnostic \u2014 any LLM via ruby_llm</li> </ul> <p>[!CAUTION] This is an experiment. It may not be fit for any specific purpose.  Its micro-prompting.  Instead of asking Claude Code, CodeX or Gemini to create an entire application, you can use SelfAgency to generate individual methods.  So far the experiments are showing good success with methods that perform math stuff on its input.</p>"},{"location":"#quick-example","title":"Quick Example","text":"<pre><code>require \"self_agency\"\n\nSelfAgency.configure do |config|\n  config.provider = :ollama\n  config.model    = \"qwen3-coder:30b\"\n  config.api_base = \"http://localhost:11434/v1\"\nend\n\nclass Calculator\n  include SelfAgency\nend\n\ncalc = Calculator.new\ncalc._(\"an instance method to add two integers, return the result\")\n#=&gt; [:add]\n\ncalc.add(3, 7)\n#=&gt; 10\n</code></pre>"},{"location":"#how-it-works","title":"How It Works","text":"<p>Your casual description is first \"shaped\" into a precise Ruby method specification, then passed through a multi-stage pipeline:</p> <ol> <li>Shape -- Rewrites your casual description into a precise Ruby method specification</li> <li>Generate -- Produces <code>def...end</code> block(s) from the shaped spec</li> <li>Sanitize -- Strips markdown fences and <code>&lt;think&gt;</code> blocks</li> <li>Validate -- Checks for empty code, missing <code>def...end</code>, syntax errors, and dangerous patterns</li> <li>Sandbox Eval -- Evaluates code inside an anonymous module that shadows dangerous Kernel methods</li> </ol>"},{"location":"#requirements","title":"Requirements","text":"<ul> <li>Ruby &gt;= 3.2.0</li> <li>An LLM provider (Ollama by default, or any provider supported by ruby_llm)</li> </ul>"},{"location":"#getting-started","title":"Getting Started","text":"<p>Head to the Installation guide to add SelfAgency to your project, then follow the Quick Start for a complete walkthrough.</p>"},{"location":"api/","title":"API Reference","text":"<p>Complete reference for SelfAgency's public API.</p>"},{"location":"api/#modules-and-classes","title":"Modules and Classes","text":"<ul> <li>SelfAgency Module -- The main mixin module with <code>_()</code>, <code>_source_for</code>, <code>_save!</code>, and <code>on_method_generated</code></li> <li>Configuration -- <code>SelfAgency::Configuration</code> class and singleton methods (<code>configure</code>, <code>reset!</code>, <code>ensure_configured!</code>)</li> <li>Errors -- Error hierarchy: <code>Error</code>, <code>GenerationError</code>, <code>ValidationError</code>, <code>SecurityError</code></li> </ul>"},{"location":"api/#quick-reference","title":"Quick Reference","text":""},{"location":"api/#instance-methods-from-include-selfagency","title":"Instance Methods (from <code>include SelfAgency</code>)","text":"Method Returns Description <code>_(description, scope:)</code> <code>Array&lt;Symbol&gt;</code> Generate and install methods from a description <code>_source_for(method_name)</code> <code>String</code> or <code>nil</code> Retrieve source code for a method <code>_save!(as:, path:)</code> <code>String</code> Save generated methods as a subclass file <code>on_method_generated(name, scope, code)</code> - Lifecycle hook (override in your class)"},{"location":"api/#class-methods-from-extend-classmethods","title":"Class Methods (from <code>extend ClassMethods</code>)","text":"Method Returns Description <code>_source_for(method_name)</code> <code>String</code> or <code>nil</code> Retrieve source code at the class level"},{"location":"api/#module-level-methods","title":"Module-Level Methods","text":"Method Returns Description <code>SelfAgency.configure { \\|c\\| ... }</code> <code>Configuration</code> Configure the gem (required) <code>SelfAgency.configuration</code> <code>Configuration</code> Access current configuration <code>SelfAgency.reset!</code> - Restore defaults <code>SelfAgency.ensure_configured!</code> - Raise if not configured"},{"location":"api/configuration/","title":"Configuration","text":""},{"location":"api/configuration/#selfagencyconfiguration","title":"<code>SelfAgency::Configuration</code>","text":"<p>Holds all configuration options. Created automatically by <code>SelfAgency.configure</code>.</p>"},{"location":"api/configuration/#attributes","title":"Attributes","text":"Attribute Type Default Description <code>provider</code> <code>Symbol</code> <code>:ollama</code> RubyLLM provider name <code>model</code> <code>String</code> <code>\"qwen3-coder:30b\"</code> LLM model identifier <code>api_base</code> <code>String</code> <code>\"http://localhost:11434/v1\"</code> Provider API endpoint <code>request_timeout</code> <code>Integer</code> <code>30</code> Request timeout in seconds <code>max_retries</code> <code>Integer</code> <code>1</code> Number of retries on failure <code>retry_interval</code> <code>Float</code> <code>0.5</code> Seconds between retries <code>template_directory</code> <code>String</code> <code>lib/self_agency/prompts</code> Path to ERB prompt templates <p>All attributes are read/write via <code>attr_accessor</code>.</p>"},{"location":"api/configuration/#module-level-methods","title":"Module-Level Methods","text":""},{"location":"api/configuration/#selfagencyconfigure-config","title":"<code>SelfAgency.configure { |config| ... }</code>","text":"<p>Configure SelfAgency. Yields a <code>Configuration</code> instance.</p> <p>Internally calls <code>RubyLLM.configure</code> and <code>RubyLLM::Template.configure</code> with the corresponding settings, then marks the gem as configured.</p> <p>Returns: <code>Configuration</code></p> <pre><code>SelfAgency.configure do |config|\n  config.provider        = :ollama\n  config.model           = \"qwen3-coder:30b\"\n  config.api_base        = \"http://localhost:11434/v1\"\n  config.request_timeout = 60\nend\n</code></pre>"},{"location":"api/configuration/#selfagencyconfiguration_1","title":"<code>SelfAgency.configuration</code>","text":"<p>Access the current configuration instance. Creates a default instance if none exists.</p> <p>Returns: <code>Configuration</code></p> <pre><code>cfg = SelfAgency.configuration\ncfg.model  #=&gt; \"qwen3-coder:30b\"\n</code></pre>"},{"location":"api/configuration/#selfagencyreset","title":"<code>SelfAgency.reset!</code>","text":"<p>Restore all configuration to defaults and mark the gem as unconfigured. Subsequent calls to <code>_()</code> will raise until <code>configure</code> is called again.</p> <pre><code>SelfAgency.reset!\n</code></pre>"},{"location":"api/configuration/#selfagencyensure_configured","title":"<code>SelfAgency.ensure_configured!</code>","text":"<p>Raise <code>SelfAgency::Error</code> if <code>configure</code> has not been called.</p> <p>Raises: <code>SelfAgency::Error</code> with message <code>\"SelfAgency.configure has not been called\"</code></p> <pre><code>SelfAgency.ensure_configured!\n</code></pre>"},{"location":"api/configuration/#selfagencyincludedbase","title":"<code>SelfAgency.included(base)</code>","text":"<p>Hook called when a class includes <code>SelfAgency</code>. Extends the including class with <code>SelfAgency::ClassMethods</code>, which provides the class-level <code>_source_for</code> method.</p> <p>This is called automatically by Ruby's <code>include</code> mechanism; you do not need to call it directly.</p>"},{"location":"api/errors/","title":"Errors","text":"<p>SelfAgency defines a hierarchy of errors under <code>SelfAgency::Error</code>.</p>"},{"location":"api/errors/#hierarchy","title":"Hierarchy","text":"<pre><code>StandardError\n  \u2514\u2500\u2500 SelfAgency::Error\n        \u251c\u2500\u2500 SelfAgency::GenerationError\n        \u251c\u2500\u2500 SelfAgency::ValidationError\n        \u2514\u2500\u2500 SelfAgency::SecurityError\n</code></pre> <p>All SelfAgency errors inherit from <code>SelfAgency::Error</code>, which inherits from <code>StandardError</code>. This means you can catch all SelfAgency errors with a single <code>rescue</code>:</p> <pre><code>rescue SelfAgency::Error =&gt; e\n</code></pre>"},{"location":"api/errors/#selfagencyerror","title":"<code>SelfAgency::Error</code>","text":"<p>Base error class. Also raised directly when configuration is missing.</p> <p>Raised when:</p> <ul> <li><code>_()</code> is called before <code>SelfAgency.configure</code></li> <li><code>_save!</code> is called with no generated methods</li> <li><code>_save!</code> is called on an anonymous class</li> </ul> <pre><code>SelfAgency.reset!\nWidget.new._(\"a method\")\n#=&gt; SelfAgency::Error: SelfAgency.configure has not been called\n</code></pre>"},{"location":"api/errors/#selfagencygenerationerror","title":"<code>SelfAgency::GenerationError</code>","text":"<p>Raised when the LLM fails to produce output.</p> <p>Raised when:</p> <ul> <li>The shape stage returns <code>nil</code> -- message: <code>\"Prompt shaping failed (LLM returned nil)\"</code></li> <li>The generate stage returns <code>nil</code> -- message: <code>\"Code generation failed (LLM returned nil)\"</code></li> </ul> <p>Note</p> <p>LLM communication failures (network errors, timeouts, provider API errors) are rescued internally by the generator. Any exception during the LLM call results in a <code>nil</code> return, which then triggers <code>GenerationError</code>. If generation consistently fails, verify your LLM provider is running and the configuration (provider, model, api_base) is correct.</p> <pre><code>rescue SelfAgency::GenerationError =&gt; e\n  puts \"LLM failed: #{e.message}\"\nend\n</code></pre>"},{"location":"api/errors/#selfagencyvalidationerror","title":"<code>SelfAgency::ValidationError</code>","text":"<p>Raised when the generated code fails structural or syntactic validation.</p> <p>Raised when:</p> <ul> <li>Generated code is empty after sanitization</li> <li>Generated code does not contain a <code>def...end</code> structure</li> <li>Generated code has a syntax error (<code>RubyVM::InstructionSequence.compile</code> fails)</li> </ul> <pre><code># Empty code\nwidget.send(:self_agency_validate!, \"\")\n#=&gt; SelfAgency::ValidationError: code is empty\n\n# Missing def...end\nwidget.send(:self_agency_validate!, \"puts 'hello'\")\n#=&gt; SelfAgency::ValidationError: missing def...end structure\n\n# Syntax error\nwidget.send(:self_agency_validate!, \"def broken\\n  if true\\nend\")\n#=&gt; SelfAgency::ValidationError: syntax error: ...\n</code></pre>"},{"location":"api/errors/#selfagencysecurityerror","title":"<code>SelfAgency::SecurityError</code>","text":"<p>Raised when the generated code contains a dangerous pattern.</p> <p>Raised when:</p> <ul> <li>The code matches <code>SelfAgency::DANGEROUS_PATTERNS</code> (static analysis)</li> </ul> <p>Note</p> <p>This is <code>SelfAgency::SecurityError</code>, distinct from Ruby's built-in <code>::SecurityError</code>. The runtime sandbox raises <code>::SecurityError</code> (the Ruby built-in), while the static validator raises <code>SelfAgency::SecurityError</code>.</p> <pre><code># System call\nwidget.send(:self_agency_validate!, \"def hack\\n  system('ls')\\nend\")\n#=&gt; SelfAgency::SecurityError: dangerous pattern detected\n\n# File access\nwidget.send(:self_agency_validate!, \"def hack\\n  File.read('/etc/passwd')\\nend\")\n#=&gt; SelfAgency::SecurityError: dangerous pattern detected\n\n# Eval\nwidget.send(:self_agency_validate!, \"def hack\\n  eval('1+1')\\nend\")\n#=&gt; SelfAgency::SecurityError: dangerous pattern detected\n</code></pre>"},{"location":"api/errors/#error-handling-patterns","title":"Error Handling Patterns","text":""},{"location":"api/errors/#catch-all-selfagency-errors","title":"Catch All SelfAgency Errors","text":"<pre><code>begin\n  obj._(\"a method description\")\nrescue SelfAgency::Error =&gt; e\n  puts \"#{e.class}: #{e.message}\"\nend\n</code></pre>"},{"location":"api/errors/#catch-specific-errors","title":"Catch Specific Errors","text":"<pre><code>begin\n  obj._(\"a method description\")\nrescue SelfAgency::GenerationError\n  puts \"LLM did not return a response\"\nrescue SelfAgency::ValidationError =&gt; e\n  puts \"Code validation failed: #{e.message}\"\nrescue SelfAgency::SecurityError\n  puts \"Dangerous code detected\"\nend\n</code></pre>"},{"location":"api/self-agency-module/","title":"SelfAgency Module","text":"<p>The main mixin module. Include it in any class to enable LLM-powered method generation.</p> <pre><code>class MyClass\n  include SelfAgency\nend\n</code></pre> <p>Including <code>SelfAgency</code> adds instance methods to the class and extends it with <code>SelfAgency::ClassMethods</code>.</p>"},{"location":"api/self-agency-module/#instance-methods","title":"Instance Methods","text":""},{"location":"api/self-agency-module/#_description-scope-instance","title":"<code>_(description, scope: :instance)</code>","text":"<p>Generate and install one or more methods from a natural language description.</p> <p>Parameters:</p> Name Type Default Description <code>description</code> <code>String</code> (required) Natural language description of the method(s) <code>scope</code> <code>Symbol</code> <code>:instance</code> One of <code>:instance</code>, <code>:singleton</code>, <code>:class</code> <p>Returns: <code>Array&lt;Symbol&gt;</code> -- names of the newly defined methods.</p> <p>Raises:</p> Exception Condition <code>SelfAgency::Error</code> <code>SelfAgency.configure</code> has not been called <code>SelfAgency::GenerationError</code> LLM returned <code>nil</code> at shape or generate stage <code>SelfAgency::ValidationError</code> Generated code is empty, malformed, or has syntax errors <code>SelfAgency::SecurityError</code> Generated code contains a dangerous pattern <p>Example:</p> <pre><code>names = obj._(\"an instance method to add two integers\")\n#=&gt; [:add]\n\nnames = obj._(\"a class method named 'self.ping' that returns 'pong'\", scope: :class)\n#=&gt; [:ping]\n</code></pre>"},{"location":"api/self-agency-module/#_source_formethod_name","title":"<code>_source_for(method_name)</code>","text":"<p>Return the source code for a method, or <code>nil</code> if unavailable.</p> <p>For LLM-generated methods, returns the code with the original description as a comment header. For file-defined methods, falls back to the <code>method_source</code> gem.</p> <p>Parameters:</p> Name Type Description <code>method_name</code> <code>Symbol</code> or <code>String</code> The method to look up <p>Returns: <code>String</code> or <code>nil</code>.</p> <p>Example:</p> <pre><code>puts obj._source_for(:add)\n# &gt;&gt; # an instance method to add two integers\n# &gt;&gt; def add(a, b)\n# &gt;&gt;   a + b\n# &gt;&gt; end\n</code></pre>"},{"location":"api/self-agency-module/#_saveas-path-nil","title":"<code>_save!(as:, path: nil)</code>","text":"<p>Save the object's generated methods as a subclass in a Ruby source file.</p> <p>Parameters:</p> Name Type Default Description <code>as</code> <code>String</code> or <code>Symbol</code> (required) Subclass name (snake_case converted to CamelCase) <code>path</code> <code>String</code> or <code>nil</code> <code>nil</code> Output file path (defaults to snake_cased name + <code>.rb</code>) <p>Returns: <code>String</code> -- the file path written to.</p> <p>Raises:</p> Exception Condition <code>ArgumentError</code> <code>as:</code> is not a String or Symbol <code>SelfAgency::Error</code> No generated methods to save <code>SelfAgency::Error</code> Parent class is anonymous <p>Example:</p> <pre><code>path = obj._save!(as: :calculator)\n#=&gt; \"calculator.rb\"\n\npath = obj._save!(as: :calculator, path: \"lib/calculator.rb\")\n#=&gt; \"lib/calculator.rb\"\n</code></pre>"},{"location":"api/self-agency-module/#on_method_generatedmethod_name-scope-code","title":"<code>on_method_generated(method_name, scope, code)</code>","text":"<p>Lifecycle hook called once per generated method. Override in your class to persist or log generated methods.</p> <p>Parameters:</p> Name Type Description <code>method_name</code> <code>Symbol</code> Name of the generated method <code>scope</code> <code>Symbol</code> <code>:instance</code>, <code>:singleton</code>, or <code>:class</code> <code>code</code> <code>String</code> The generated source code <p>Default behavior: No-op.</p> <p>Example:</p> <pre><code>def on_method_generated(method_name, scope, code)\n  File.write(\"generated/#{method_name}.rb\", code)\nend\n</code></pre>"},{"location":"api/self-agency-module/#class-methods-via-classmethods","title":"Class Methods (via ClassMethods)","text":""},{"location":"api/self-agency-module/#_source_formethod_name_1","title":"<code>_source_for(method_name)</code>","text":"<p>Class-level version of <code>_source_for</code>. Works identically to the instance method but is called on the class.</p> <p>Parameters:</p> Name Type Description <code>method_name</code> <code>Symbol</code> or <code>String</code> The method to look up <p>Returns: <code>String</code> or <code>nil</code>.</p> <p>Example:</p> <pre><code>puts MyClass._source_for(:add)\n</code></pre>"},{"location":"architecture/overview/","title":"Architecture Overview","text":"<p>SelfAgency uses a two-stage LLM pipeline with multi-layer security to generate and install methods at runtime.</p>"},{"location":"architecture/overview/#pipeline","title":"Pipeline","text":"<pre><code>flowchart TD\n    A[\"User calls _('description')\"] --&gt; B[ensure_configured!]\n    B --&gt; C[Shape Stage]\n    C --&gt; D{Shaped spec nil?}\n    D --&gt;|Yes| E[Raise GenerationError]\n    D --&gt;|No| F[Generate Stage]\n    F --&gt; G{Raw code nil?}\n    G --&gt;|Yes| E\n    G --&gt;|No| H[Sanitize]\n    H --&gt; I[Validate]\n    I --&gt; J{Valid?}\n    J --&gt;|No| K[Raise ValidationError or SecurityError]\n    J --&gt;|Yes| L[Sandbox Eval]\n    L --&gt; M[Split Methods]\n    M --&gt; N[Store Source]\n    N --&gt; O[Fire on_method_generated Hook]\n    O --&gt; P[\"Return Array&lt;Symbol&gt;\"]</code></pre>"},{"location":"architecture/overview/#stage-1-shape","title":"Stage 1: Shape","text":"<p>The shape stage rewrites a casual language description into a precise Ruby method specification. It uses ERB templates from the <code>shape/</code> directory.</p> <p>The LLM receives class context:</p> <ul> <li>Class name -- e.g., <code>Calculator</code></li> <li>Instance variables -- e.g., <code>@data, @name</code></li> <li>Public methods -- e.g., <code>add, subtract, mean</code></li> <li>Scope instruction -- e.g., \"This will be an instance method available on all instances of the class.\"</li> </ul> <p>The shape stage does not produce code. It produces a refined natural language specification that the generate stage can work with reliably.</p>"},{"location":"architecture/overview/#stage-2-generate","title":"Stage 2: Generate","text":"<p>The generate stage takes the shaped specification and produces a <code>def...end</code> block. It uses templates from the <code>generate/</code> directory.</p> <p>The LLM receives the same class context plus the shaped specification from stage 1.</p>"},{"location":"architecture/overview/#post-processing","title":"Post-Processing","text":"<p>After generation, the raw LLM output goes through three steps:</p>"},{"location":"architecture/overview/#sanitize","title":"Sanitize","text":"<p>Strips artifacts from the LLM response:</p> <ul> <li>Markdown code fences (<code>```ruby ... ```</code>)</li> <li><code>&lt;think&gt;</code> blocks (used by some models for chain-of-thought reasoning)</li> <li>Leading/trailing whitespace</li> </ul>"},{"location":"architecture/overview/#validate","title":"Validate","text":"<p>Four checks run in sequence:</p> <ol> <li>Non-empty -- Code must not be blank</li> <li>Structure -- Must contain at least one <code>def...end</code> block</li> <li>Security -- Must not match any <code>DANGEROUS_PATTERNS</code></li> <li>Syntax -- Must compile via <code>RubyVM::InstructionSequence.compile</code></li> </ol>"},{"location":"architecture/overview/#sandbox-eval","title":"Sandbox Eval","text":"<p>The validated code is evaluated inside an anonymous module that includes <code>SelfAgency::Sandbox</code>. This module shadows dangerous Kernel methods, placing them ahead of Kernel in Ruby's method resolution order (MRO).</p> <p>The module is then prepended to the appropriate target:</p> Scope Prepend Target <code>:instance</code> <code>self.class</code> <code>:singleton</code> <code>singleton_class</code> <code>:class</code> <code>self.class.singleton_class</code>"},{"location":"architecture/overview/#module-structure","title":"Module Structure","text":"<pre><code>classDiagram\n    class SelfAgency {\n        +_(description, scope) Array~Symbol~\n        +_source_for(method_name) String?\n        +_save!(as, path) String\n        +on_method_generated(name, scope, code)\n    }\n\n    class ClassMethods {\n        +_source_for(method_name) String?\n    }\n\n    class Configuration {\n        +provider Symbol\n        +model String\n        +api_base String\n        +request_timeout Integer\n        +max_retries Integer\n        +retry_interval Float\n        +template_directory String\n    }\n\n    class Sandbox {\n        -system(*) raises SecurityError\n        -exec(*) raises SecurityError\n        -spawn(*) raises SecurityError\n        -fork(*) raises SecurityError\n        -backticks(*) raises SecurityError\n        -open(*) raises SecurityError\n    }\n\n    class Validator {\n        +DANGEROUS_PATTERNS Regexp\n        -self_agency_sanitize(raw) String\n        -self_agency_validate!(code)\n    }\n\n    class Generator {\n        -self_agency_ask_with_template(name, **vars) String?\n        -self_agency_shape(prompt, scope) String?\n        -self_agency_generation_vars() Hash\n    }\n\n    class Saver {\n        -self_agency_to_class_name(value) String\n        -self_agency_to_snake_case(name) String\n        -self_agency_relative_require(output, source) String\n        -self_agency_build_subclass_source(...) String\n    }\n\n    SelfAgency --&gt; ClassMethods : extends including class\n    SelfAgency --&gt; Configuration : uses\n    SelfAgency --&gt; Sandbox : includes in eval module\n    SelfAgency --&gt; Validator : validates code\n    SelfAgency --&gt; Generator : calls LLM\n    SelfAgency --&gt; Saver : persists methods</code></pre>"},{"location":"architecture/overview/#file-layout","title":"File Layout","text":"<pre><code>lib/\n  self_agency.rb            # Main module, public API, eval logic\n  self_agency/\n    version.rb              # VERSION constant\n    errors.rb               # Error hierarchy\n    configuration.rb        # Configuration class and singleton methods\n    sandbox.rb              # Runtime sandbox module\n    validator.rb            # DANGEROUS_PATTERNS, sanitize, validate!\n    generator.rb            # LLM communication and prompt shaping\n    saver.rb                # _save! helpers\n    prompts/\n      shape/\n        system.txt.erb      # Shape stage system prompt\n        user.txt.erb        # Shape stage user prompt\n      generate/\n        system.txt.erb      # Generate stage system prompt\n        user.txt.erb        # Generate stage user prompt\n</code></pre>"},{"location":"architecture/security/","title":"Security","text":"<p>SelfAgency employs a two-layer security model to prevent generated code from performing dangerous operations. Both layers must pass before any code is installed.</p>"},{"location":"architecture/security/#layer-1-static-analysis","title":"Layer 1: Static Analysis","text":"<p>Before code is evaluated, it is checked against <code>DANGEROUS_PATTERNS</code>, a compiled regular expression that matches known dangerous constructs:</p> Pattern What It Catches <code>\\b(system\\|exec\\|spawn\\|fork\\|abort\\|exit)\\b</code> Process execution and termination <code>`[^`]*`</code> Backtick shell execution <code>%x\\{</code>, <code>%x\\[</code>, <code>%x\\(</code> <code>%x</code> shell execution syntax <code>\\bFile\\.\\b</code> File system access <code>\\bIO\\.\\b</code> I/O operations <code>\\bKernel\\.\\b</code> Direct Kernel calls <code>\\bOpen3\\.\\b</code> Advanced process spawning <code>\\bProcess\\.\\b</code> Process management <code>\\brequire\\b</code> Loading external code <code>\\bload\\b</code> Loading external code <code>\\b__send__\\b</code> Method dispatch bypass <code>\\beval\\b</code> Dynamic code evaluation <code>\\bsend\\b(?!\\s*\\()</code> Method dispatch without parentheses (blocks <code>send :foo</code> but allows <code>send(</code> with parens) <code>\\bremove_method\\b</code> Method removal <code>\\bundef_method\\b</code> Method undefinition <p>If any pattern matches, a <code>SelfAgency::SecurityError</code> is raised and the code is not evaluated.</p> <pre><code># These all raise SelfAgency::SecurityError:\n\"def hack\\n  system('ls')\\nend\"\n\"def hack\\n  File.read('/etc/passwd')\\nend\"\n\"def hack\\n  eval('1+1')\\nend\"\n\"def hack\\n  require 'socket'\\nend\"\n</code></pre>"},{"location":"architecture/security/#layer-2-runtime-sandbox","title":"Layer 2: Runtime Sandbox","text":"<p>Even if static analysis were bypassed, the runtime sandbox provides a second line of defense. Every generated method is evaluated inside an anonymous module that includes <code>SelfAgency::Sandbox</code>:</p> <pre><code>module SelfAgency::Sandbox\n  private\n\n  def system(*)  = raise(::SecurityError, \"system() blocked by SelfAgency sandbox\")\n  def exec(*)    = raise(::SecurityError, \"exec() blocked by SelfAgency sandbox\")\n  def spawn(*)   = raise(::SecurityError, \"spawn() blocked by SelfAgency sandbox\")\n  def fork(*)    = raise(::SecurityError, \"fork() blocked by SelfAgency sandbox\")\n  def `(*)       = raise(::SecurityError, \"backtick execution blocked by SelfAgency sandbox\")\n  def open(*)    = raise(::SecurityError, \"open() blocked by SelfAgency sandbox\")\nend\n</code></pre> <p>Because the sandbox module is included in the anonymous module that wraps the generated code, its methods appear ahead of Kernel in Ruby's method resolution order (MRO). Any call to <code>system</code>, <code>exec</code>, <code>spawn</code>, <code>fork</code>, backticks, or <code>open</code> from within a generated method raises <code>::SecurityError</code> at runtime.</p>"},{"location":"architecture/security/#validation-pipeline","title":"Validation Pipeline","text":"<p>The full validation sequence runs in order. The first failure stops evaluation:</p> <pre><code>flowchart LR\n    A[Raw LLM Output] --&gt; B[Sanitize]\n    B --&gt; C{Empty?}\n    C --&gt;|Yes| D[ValidationError]\n    C --&gt;|No| E{\"Has def...end?\"}\n    E --&gt;|No| D\n    E --&gt;|Yes| F{Dangerous pattern?}\n    F --&gt;|Yes| G[SecurityError]\n    F --&gt;|No| H{Syntax valid?}\n    H --&gt;|No| D\n    H --&gt;|Yes| I[Sandbox Eval]</code></pre> <ol> <li>Sanitize -- Strip markdown fences, <code>&lt;think&gt;</code> blocks, whitespace</li> <li>Empty check -- Raise <code>ValidationError</code> if code is blank</li> <li>Structure check -- Raise <code>ValidationError</code> if no <code>def...end</code> block found</li> <li>Pattern check -- Raise <code>SecurityError</code> if <code>DANGEROUS_PATTERNS</code> matches</li> <li>Syntax check -- Raise <code>ValidationError</code> if <code>RubyVM::InstructionSequence.compile</code> fails</li> <li>Sandbox eval -- Evaluate inside sandboxed anonymous module</li> </ol>"},{"location":"architecture/security/#limitations","title":"Limitations","text":"<p>The security model is designed for defense-in-depth against accidental or LLM-hallucinated dangerous code. It is not a full sandboxing solution:</p> <ul> <li>Static patterns can potentially be bypassed through creative obfuscation</li> <li>The runtime sandbox only shadows six specific Kernel methods</li> <li>Generated code has access to the full Ruby standard library (except blocked methods)</li> <li>Network access (e.g., <code>Net::HTTP</code>) is not blocked by default</li> </ul> <p>For production use, consider additional controls such as network-level restrictions, process isolation, or reviewing generated code before deployment (see <code>_save!</code>).</p>"},{"location":"development/contributing/","title":"Contributing","text":""},{"location":"development/contributing/#getting-started","title":"Getting Started","text":"<ol> <li>Fork the repository</li> <li>Clone your fork</li> <li>Install dependencies: <code>bin/setup</code></li> <li>Create a feature branch: <code>git checkout -b my-feature</code></li> <li>Make your changes</li> <li>Run the tests: <code>rake test</code></li> <li>Commit and push</li> <li>Open a pull request</li> </ol>"},{"location":"development/contributing/#guidelines","title":"Guidelines","text":""},{"location":"development/contributing/#code-style","title":"Code Style","text":"<ul> <li>Follow existing patterns in the codebase</li> <li>All private helpers are prefixed <code>self_agency_</code> to avoid name collisions with host classes</li> <li>Keep the gem's runtime dependency count minimal</li> </ul>"},{"location":"development/contributing/#testing","title":"Testing","text":"<ul> <li>All tests must pass offline (no LLM connection required)</li> <li>Add tests for new features or bug fixes</li> <li>Test validation, sanitization, and security patterns directly</li> </ul>"},{"location":"development/contributing/#security","title":"Security","text":"<ul> <li>Any changes to <code>DANGEROUS_PATTERNS</code> or <code>Sandbox</code> must be carefully reviewed</li> <li>New patterns should have corresponding test cases</li> <li>The two-layer security model (static + runtime) should be maintained</li> </ul>"},{"location":"development/contributing/#documentation","title":"Documentation","text":"<ul> <li>Update relevant docs pages for user-facing changes</li> <li>Run <code>mkdocs serve</code> to preview documentation changes locally</li> </ul>"},{"location":"development/contributing/#reporting-issues","title":"Reporting Issues","text":"<p>Report bugs and feature requests on GitHub Issues.</p>"},{"location":"development/contributing/#license","title":"License","text":"<p>By contributing, you agree that your contributions will be licensed under the MIT License.</p>"},{"location":"development/setup/","title":"Development Setup","text":""},{"location":"development/setup/#prerequisites","title":"Prerequisites","text":"<ul> <li>Ruby &gt;= 3.2.0</li> <li>Bundler</li> </ul>"},{"location":"development/setup/#getting-started","title":"Getting Started","text":"<p>Clone the repository and install dependencies:</p> <pre><code>git clone https://github.com/madbomber/self_agency.git\ncd self_agency\nbin/setup\n</code></pre> <p><code>bin/setup</code> installs gem dependencies via Bundler.</p>"},{"location":"development/setup/#dependencies","title":"Dependencies","text":""},{"location":"development/setup/#runtime","title":"Runtime","text":"Gem Purpose <code>ruby_llm</code> LLM provider communication <code>ruby_llm-template</code> ERB prompt template management <code>method_source</code> Source code retrieval for file-defined methods"},{"location":"development/setup/#development","title":"Development","text":"Gem Purpose <code>minitest</code> Test framework <code>rake</code> Task runner <code>simplecov</code> Code coverage <code>debug_me</code> Debugging output <code>irb</code> Interactive console"},{"location":"development/setup/#console","title":"Console","text":"<p>Start an interactive console with the gem preloaded:</p> <pre><code>bin/console\n</code></pre>"},{"location":"development/setup/#project-structure","title":"Project Structure","text":"<pre><code>self_agency/\n  lib/\n    self_agency.rb              # Main module\n    self_agency/\n      version.rb                # VERSION constant\n      errors.rb                 # Error hierarchy\n      configuration.rb          # Configuration + singleton methods\n      sandbox.rb                # Runtime sandbox\n      validator.rb              # Static analysis + validation\n      generator.rb              # LLM communication\n      saver.rb                  # _save! helpers\n      prompts/                  # ERB templates\n        shape/\n          system.txt.erb\n          user.txt.erb\n        generate/\n          system.txt.erb\n          user.txt.erb\n  test/\n    test_helper.rb              # Test setup\n    test_configuration.rb       # Configuration tests\n    test_generator.rb           # Generator tests\n    test_pipeline.rb            # Pipeline tests\n    test_sandbox.rb             # Sandbox tests\n    test_save.rb                # _save! tests\n    test_source_for.rb          # Source inspection tests\n    test_templates.rb           # Template tests\n    test_validator.rb           # Validator tests\n  examples/                     # 12 example scripts\n  docs/                         # This documentation\n</code></pre>"},{"location":"development/testing/","title":"Testing","text":"<p>SelfAgency uses Minitest. All tests run offline -- they exercise configuration, validation, sanitization, and sandboxing without calling an LLM.</p>"},{"location":"development/testing/#running-tests","title":"Running Tests","text":"<p>Run the full test suite:</p> <pre><code>rake test\n</code></pre> <p>This is the default Rake task, so <code>rake</code> alone works too:</p> <pre><code>rake\n</code></pre>"},{"location":"development/testing/#running-individual-tests","title":"Running Individual Tests","text":"<p>Run a specific test file:</p> <pre><code>bundle exec ruby -Ilib -Itest test/test_validator.rb\n</code></pre> <p>Run a single test method:</p> <pre><code>bundle exec ruby -Ilib -Itest test/test_validator.rb -n test_method_name\n</code></pre>"},{"location":"development/testing/#test-structure","title":"Test Structure","text":"File Tests <code>test_configuration.rb</code> Configuration options, <code>reset!</code>, <code>ensure_configured!</code> <code>test_generator.rb</code> Generator helper methods <code>test_pipeline.rb</code> End-to-end pipeline logic <code>test_sandbox.rb</code> Runtime sandbox blocks dangerous methods <code>test_save.rb</code> <code>_save!</code> file generation <code>test_source_for.rb</code> <code>_source_for</code> at instance and class level <code>test_templates.rb</code> Prompt template loading <code>test_validator.rb</code> Sanitization, validation, security patterns"},{"location":"development/testing/#test-design","title":"Test Design","text":"<p>Tests define a <code>SampleClass</code> that includes <code>SelfAgency</code> for testing private helpers via <code>send</code>. This avoids needing a live LLM connection -- the tests exercise the internal machinery directly:</p> <pre><code>class SampleClass\n  include SelfAgency\nend\n\n# Test private helpers\nobj = SampleClass.new\nobj.send(:self_agency_validate!, code)\nobj.send(:self_agency_sanitize, raw)\n</code></pre>"},{"location":"development/testing/#code-coverage","title":"Code Coverage","text":"<p>SimpleCov runs automatically with every test execution. Coverage reports are generated in the <code>coverage/</code> directory after each <code>rake test</code> run:</p> <pre><code>rake test\n# Coverage report written to coverage/\n</code></pre> <p>Open <code>coverage/index.html</code> in a browser to view the detailed report.</p>"},{"location":"examples/","title":"Examples","text":"<p>SelfAgency ships with 12 examples that progressively demonstrate its features. All examples live in the <code>examples/</code> directory.</p>"},{"location":"examples/#running-examples","title":"Running Examples","text":"<p>Most examples require a running LLM. The default configuration targets Ollama:</p> <pre><code># Start Ollama\nollama serve\n\n# Run an example\nbundle exec ruby examples/01_basic_usage.rb\n</code></pre> <p>Examples 06 and 07 run offline (no LLM required) as they only exercise configuration and error handling.</p>"},{"location":"examples/#example-index","title":"Example Index","text":"# Name Features LLM Required 01 Basic Usage <code>_()</code>, single method generation Yes 02 Multiple Methods Multiple methods from one call Yes 03 Scopes Instance, singleton, class scopes Yes 04 Source Inspection <code>_source_for</code>, file fallback Yes 05 Lifecycle Hook <code>on_method_generated</code> Yes 06 Configuration All config options, <code>reset!</code>, <code>ensure_configured!</code> No 07 Error Handling Error hierarchy, rescue patterns No 08 Class Context Instance variables, method awareness Yes 09 Method Override Replacing existing methods Yes 10 Full Workflow Complete real-world workflow Yes 11 Collaborative Robots Multi-robot pipeline, message bus Yes 12 Autonomous Robots Three-layer LLM, self-repair Yes <p>Examples 01--09 are covered in Basic Examples. Examples 10--12 each have their own deep-dive page.</p>"},{"location":"examples/autonomous-robots/","title":"Example 12: Autonomous Robots","text":"<p>Three robots autonomously build a city landmarks tour pipeline. Unlike Example 11, each robot receives only a high-level goal -- the LLM decides method names, algorithms, and data structures.</p> <p>Source: <code>examples/12_autonomous_robots/</code></p>"},{"location":"examples/autonomous-robots/#architecture","title":"Architecture","text":"<pre><code>flowchart LR\n    A[Collector] --&gt;|landmark data| B[Analyst]\n    B --&gt;|analyzed data| C[Planner]\n    C --&gt;|itinerary| D[Output]\n\n    style A fill:#6366f1,color:#fff\n    style B fill:#8b5cf6,color:#fff\n    style C fill:#a855f7,color:#fff</code></pre> Robot Goal Methods Collector Return an Array of 8 fictional city landmarks LLM decides Analyst Analyze landmark data (statistics, ranking, grouping) LLM decides Planner Create a formatted one-day tour itinerary LLM decides"},{"location":"examples/autonomous-robots/#three-layer-llm-approach","title":"Three-Layer LLM Approach","text":"<p>This example adds a third layer compared to Example 11:</p> <ol> <li>Layer 1 (Decompose): Ask the LLM to break a high-level goal into helper method specs. The LLM chooses method names, parameters, and algorithms</li> <li>Layer 2 (Generate Helpers): Loop through specs, call <code>_()</code> for each. SelfAgency handles shape, generate, validate, sandbox eval</li> <li>Layer 3 (Generate Orchestrator): A final <code>_()</code> call generates an <code>execute_task</code> method that wires the helpers together</li> </ol> <pre><code>flowchart TD\n    A[High-Level Goal] --&gt; B[\"Layer 1: Decompose\"]\n    B --&gt; C[\"JSON specs&lt;br/&gt;(LLM-chosen names)\"]\n    C --&gt; D[\"Layer 2: Generate Helpers\"]\n    D --&gt; E[\"Layer 3: Generate Orchestrator\"]\n    E --&gt; F[Robot Ready]</code></pre>"},{"location":"examples/autonomous-robots/#self-repair","title":"Self-Repair","text":"<p>If <code>execute_task</code> raises at runtime, the robot attempts self-repair:</p> <ol> <li>Identify the failing method from the backtrace</li> <li>Build a repair prompt with the error, current source, goal context, and input data shape</li> <li>Regenerate the failing method via <code>_()</code> with <code>scope: :singleton</code></li> <li>Retry (up to <code>MAX_REPAIR_ATTEMPTS = 3</code>)</li> </ol> <pre><code>def perform_task(input = nil)\n  attempts = 0\n\n  begin\n    execute_task(input)\n  rescue =&gt; error\n    attempts += 1\n    if attempts &lt; MAX_REPAIR_ATTEMPTS\n      repair_method(error, input)\n      retry\n    end\n  end\nend\n</code></pre> <p>The repair prompt includes:</p> <ul> <li>The robot's overall goal</li> <li>All generated capabilities</li> <li>The current source code of the failing method</li> <li>The runtime error (class, message, backtrace)</li> <li>A description of the input data shape (class, keys, sample elements)</li> </ul>"},{"location":"examples/autonomous-robots/#key-differences-from-example-11","title":"Key Differences from Example 11","text":"Aspect Example 11 (Collaborative) Example 12 (Autonomous) Task description Prescriptive (exact method names, algorithms) Goal-oriented (what, not how) LLM layers 2 (analyze + generate) 3 (decompose + generate + orchestrate) Method naming Dictated by user Chosen by LLM Error recovery None Self-repair with retry Scope Instance methods Singleton methods"},{"location":"examples/autonomous-robots/#pipeline-execution","title":"Pipeline Execution","text":"<pre><code># Step 1: Collector builds a landmark catalog\ncollector_result = collector.perform_task\n\n# Step 2: Analyst processes the catalog\nanalyst_result = analyst.perform_task(analyst_input)\n\n# Step 3: Planner creates the itinerary\nfinal_itinerary = planner.perform_task(planner_input)\n</code></pre>"},{"location":"examples/autonomous-robots/#saving-robots","title":"Saving Robots","text":"<p>Each robot's generated methods are saved as a subclass:</p> <pre><code>[collector, analyst, planner].each do |robot|\n  path = robot._save!(as: robot.name)\nend\n</code></pre> <p>This captures the LLM's autonomous design decisions as permanent Ruby source files.</p>"},{"location":"examples/basic-examples/","title":"Basic Examples (01--09)","text":"<p>These examples cover SelfAgency's core features one at a time.</p>"},{"location":"examples/basic-examples/#01-basic-usage","title":"01: Basic Usage","text":"<p>The simplest example: include <code>SelfAgency</code>, generate a single method, call it.</p> <pre><code>class Calculator\n  include SelfAgency\nend\n\ncalc = Calculator.new\nmethod_names = calc._(\"an instance method named 'add' that accepts two integer parameters a and b, and returns their sum\")\n\nputs method_names.inspect  #=&gt; [:add]\nputs calc.add(3, 7)        #=&gt; 10\n</code></pre> <p>Source: <code>examples/01_basic_usage.rb</code></p>"},{"location":"examples/basic-examples/#02-multiple-methods","title":"02: Multiple Methods","text":"<p>Generate several related methods in a single <code>_()</code> call.</p> <pre><code>class Arithmetic\n  include SelfAgency\nend\n\narith = Arithmetic.new\nmethod_names = arith._(\n  \"create four instance methods: \" \\\n  \"'add(a, b)' returns a + b, \" \\\n  \"'subtract(a, b)' returns a - b, \" \\\n  \"'multiply(a, b)' returns a * b, \" \\\n  \"'divide(a, b)' returns a.to_f / b (raises ZeroDivisionError if b is zero)\"\n)\n\nputs method_names.inspect  #=&gt; [:add, :subtract, :multiply, :divide]\nputs arith.multiply(10, 3) #=&gt; 30\n</code></pre> <p>Source: <code>examples/02_multiple_methods.rb</code></p>"},{"location":"examples/basic-examples/#03-scopes","title":"03: Scopes","text":"<p>Demonstrates all three scopes: instance, singleton, and class.</p> <pre><code>class Greeter\n  include SelfAgency\nend\n\nalice = Greeter.new\nbob   = Greeter.new\n\n# Instance -- available to all instances\nalice._(\"an instance method named 'hello' that returns 'Hello, world!'\")\nbob.hello  #=&gt; \"Hello, world!\"\n\n# Singleton -- available to one instance only\nalice._(\"a method named 'secret' that returns 'Alice only'\", scope: :singleton)\nalice.secret                 #=&gt; \"Alice only\"\nbob.respond_to?(:secret)     #=&gt; false\n\n# Class -- available on the class itself\nalice._(\"a class method named 'self.class_greeting' that returns 'Greetings from Greeter'\", scope: :class)\nGreeter.class_greeting       #=&gt; \"Greetings from Greeter\"\n</code></pre> <p>Source: <code>examples/03_scopes.rb</code></p>"},{"location":"examples/basic-examples/#04-source-inspection","title":"04: Source Inspection","text":"<p>View generated source code and the fallback to <code>method_source</code> for file-defined methods.</p> <pre><code>class MathHelper\n  include SelfAgency\n\n  # Multiplies a number by two.\n  def double(n)\n    n * 2\n  end\nend\n\nhelper = MathHelper.new\nhelper._(\"an instance method named 'square' that accepts an integer n and returns n * n\")\n\n# LLM-generated method (includes description as comment header)\nputs helper._source_for(:square)\n\n# File-defined method (falls back to method_source gem)\nputs helper._source_for(:double)\n\n# Unknown method\nhelper._source_for(:nonexistent)  #=&gt; nil\n</code></pre> <p>Source: <code>examples/04_source_inspection.rb</code></p>"},{"location":"examples/basic-examples/#05-lifecycle-hook","title":"05: Lifecycle Hook","text":"<p>Override <code>on_method_generated</code> to log or persist each generated method.</p> <pre><code>class PersistentCalculator\n  include SelfAgency\n\n  attr_reader :generation_log\n\n  def initialize\n    @generation_log = []\n  end\n\n  def on_method_generated(method_name, scope, code)\n    @generation_log &lt;&lt; { method_name: method_name, scope: scope, code: code }\n    puts \"[hook] Generated :#{method_name} (scope: #{scope})\"\n  end\nend\n\ncalc = PersistentCalculator.new\ncalc._(\"an instance method named 'increment' that returns n + 1\")\n# [hook] Generated :increment (scope: instance)\n</code></pre> <p>Source: <code>examples/05_lifecycle_hook.rb</code></p>"},{"location":"examples/basic-examples/#06-configuration","title":"06: Configuration","text":"<p>Explores all configuration options. Runs offline (no LLM required).</p> <p>Demonstrates:</p> <ul> <li>Default values before <code>configure</code></li> <li><code>ensure_configured!</code> raises before <code>configure</code></li> <li>Setting custom values</li> <li><code>reset!</code> restores defaults</li> <li>Custom <code>template_directory</code></li> </ul> <p>Source: <code>examples/06_configuration.rb</code></p>"},{"location":"examples/basic-examples/#07-error-handling","title":"07: Error Handling","text":"<p>Exercises the error hierarchy. Runs offline (no LLM required).</p> <p>Demonstrates:</p> <ul> <li><code>SelfAgency::Error</code> hierarchy verification</li> <li>Calling <code>_()</code> before <code>configure</code> raises <code>Error</code></li> <li><code>ValidationError</code> for empty code, missing <code>def...end</code>, syntax errors</li> <li><code>SecurityError</code> for <code>system</code>, <code>File</code>, <code>eval</code>, <code>require</code> patterns</li> <li>Catching all errors with <code>rescue SelfAgency::Error</code></li> </ul> <p>Source: <code>examples/07_error_handling.rb</code></p>"},{"location":"examples/basic-examples/#08-class-context","title":"08: Class Context","text":"<p>Shows how the LLM receives class introspection (class name, instance variables, public methods) to generate context-aware code.</p> <pre><code>class BankAccount\n  include SelfAgency\n\n  attr_reader :owner, :balance\n\n  def initialize(owner, balance)\n    @owner   = owner\n    @balance = balance\n  end\n\n  def deposit(amount)\n    @balance += amount\n  end\nend\n\naccount = BankAccount.new(\"Alice\", 1000)\naccount._(\n  \"an instance method named 'summary' that returns 'Account for &lt;owner&gt;: $&lt;balance&gt;'\"\n)\n\nputs account.summary  #=&gt; \"Account for Alice: $1000\"\n</code></pre> <p>Source: <code>examples/08_class_context.rb</code></p>"},{"location":"examples/basic-examples/#09-method-override","title":"09: Method Override","text":"<p>Demonstrates that generating a method with the same name as an existing method overrides it via <code>Module#prepend</code>.</p> <pre><code>class Formatter\n  include SelfAgency\n\n  def greet(name)\n    \"Hello, #{name}\"\n  end\nend\n\nfmt = Formatter.new\nputs fmt.greet(\"World\")  #=&gt; \"Hello, World\"\n\nfmt._(\n  \"an instance method named 'greet' that returns 'Greetings, &lt;name&gt;! Welcome aboard.'\"\n)\n\nputs fmt.greet(\"World\")  #=&gt; \"Greetings, World! Welcome aboard.\"\n</code></pre> <p>The MRO shows the prepended module:</p> <pre><code>0. #&lt;Module:0x...&gt;  \u2190 anonymous module with generated method\n1. Formatter\n2. SelfAgency\n3. ...\n</code></pre> <p>Source: <code>examples/09_method_override.rb</code></p>"},{"location":"examples/collaborative-robots/","title":"Example 11: Collaborative Robots","text":"<p>Three robots collaborate through a shared message bus to build a weather data pipeline. Each robot's methods are generated by the LLM based on detailed task descriptions.</p> <p>Source: <code>examples/11_collaborative_robots/</code></p>"},{"location":"examples/collaborative-robots/#architecture","title":"Architecture","text":"<pre><code>flowchart LR\n    A[Atlas] --&gt;|weather data| B[Nova]\n    B --&gt;|analyzed data| C[Echo]\n    C --&gt;|formatted report| D[Output]\n\n    style A fill:#6366f1,color:#fff\n    style B fill:#8b5cf6,color:#fff\n    style C fill:#a855f7,color:#fff</code></pre> <p>Three robots connected by a <code>MessageBus</code>:</p> Robot Role Methods Generated Atlas Data generator <code>generate_weather_data</code>, <code>summarize_raw_data</code> Nova Analyzer <code>compute_basic_statistics</code>, <code>classify_conditions</code> Echo Reporter <code>format_weather_report</code>"},{"location":"examples/collaborative-robots/#two-layer-llm-approach","title":"Two-Layer LLM Approach","text":"<p>This example uses a two-layer approach:</p> <ol> <li>Layer 1 (Analyze): A direct <code>RubyLLM.chat().ask()</code> call decomposes the task description into a JSON array of method specifications</li> <li>Layer 2 (Generate): Loops through the specs and calls <code>_()</code> for each one. SelfAgency handles shape, generate, validate, and sandbox eval</li> </ol> <p>The task descriptions are prescriptive -- they dictate exact method names, parameters, algorithms, and data structures.</p>"},{"location":"examples/collaborative-robots/#robot-class","title":"Robot Class","text":"<p>The <code>Robot</code> class includes <code>SelfAgency</code> and adds:</p> <ul> <li>Task decomposition via <code>analyze_task</code> -- asks the LLM to parse a task into method specs</li> <li>Pipeline execution via <code>execute</code> -- chains generated methods by arity</li> <li>Message bus -- <code>send_message</code>, <code>receive_message</code>, <code>broadcast</code></li> <li>Generation logging via <code>on_method_generated</code></li> <li>Persistence via <code>_save!</code> -- saves each robot as a subclass</li> </ul> <pre><code>class Robot\n  include SelfAgency\n\n  attr_reader :name, :task, :bus, :inbox, :capabilities, :generation_log\n\n  def initialize(name:, task:, bus:)\n    @name = name\n    @task = task\n    @bus  = bus\n    # ... decompose task, generate methods\n  end\n\n  def execute(input = nil)\n    # Chain capabilities by arity\n  end\nend\n</code></pre>"},{"location":"examples/collaborative-robots/#pipeline-execution","title":"Pipeline Execution","text":"<pre><code># Step 1: Atlas generates weather data\natlas_result = atlas.execute\natlas.send_message(to: \"Nova\", content: atlas_result)\n\n# Step 2: Nova analyzes the data\nnova_input = nova.inbox.last&amp;.dig(:content)\nnova_result = nova.execute(nova_input)\nnova.send_message(to: \"Echo\", content: nova_result)\n\n# Step 3: Echo formats the report\necho_input = echo.inbox.last&amp;.dig(:content)\nfinal_report = echo.execute(echo_input)\n</code></pre>"},{"location":"examples/collaborative-robots/#saving-robots","title":"Saving Robots","text":"<p>After the pipeline runs, each robot's generated methods are saved as a subclass file:</p> <pre><code>[atlas, nova, echo].each do |robot|\n  path = robot._save!(as: robot.name)\n  puts \"#{robot.name}: saved to #{path}\"\nend\n</code></pre> <p>This produces files like <code>atlas.rb</code>, <code>nova.rb</code>, <code>echo.rb</code>, each containing a <code>Robot</code> subclass with the generated methods baked in.</p>"},{"location":"examples/collaborative-robots/#key-difference-from-example-12","title":"Key Difference from Example 12","text":"<p>In this example, the task descriptions dictate method names and algorithms. The LLM is told exactly what to implement. Compare with Example 12: Autonomous Robots, where robots receive only a high-level goal and the LLM decides everything.</p>"},{"location":"examples/full-workflow/","title":"Example 10: Full Workflow","text":"<p>A complete real-world workflow that combines all SelfAgency features: multiple scopes, lifecycle hooks, source inspection, and file persistence.</p> <p>Source: <code>examples/10_full_workflow.rb</code></p>"},{"location":"examples/full-workflow/#overview","title":"Overview","text":"<p>Builds a <code>StatisticsCalculator</code> class that:</p> <ol> <li>Generates instance methods (<code>mean</code>, <code>median</code>, <code>standard_deviation</code>)</li> <li>Generates a class method (<code>self.from_range</code>)</li> <li>Generates a singleton method (<code>report</code>)</li> <li>Persists all generated code to files via <code>on_method_generated</code></li> <li>Inspects source for all generated methods</li> </ol>"},{"location":"examples/full-workflow/#the-class","title":"The Class","text":"<pre><code>class StatisticsCalculator\n  include SelfAgency\n\n  attr_reader :data\n\n  def initialize(data = [])\n    @data = data.dup\n  end\n\n  def on_method_generated(method_name, scope, code)\n    filename = \"#{method_name}_#{scope}.rb\"\n    filepath = File.join(GENERATED_DIR, filename)\n    File.write(filepath, code)\n    puts \"  [saved] #{filepath}\"\n  end\nend\n</code></pre>"},{"location":"examples/full-workflow/#what-it-generates","title":"What It Generates","text":""},{"location":"examples/full-workflow/#instance-methods","title":"Instance Methods","text":"<pre><code>calc = StatisticsCalculator.new([10, 20, 30, 40, 50, 60, 70, 80, 90, 100])\n\ncalc._(\"an instance method named 'mean' that calculates the arithmetic mean of @data as a Float\")\ncalc._(\"an instance method named 'median' that returns the median value of @data as a Float\")\ncalc._(\"an instance method named 'standard_deviation' that returns the population standard deviation of @data as a Float\")\n</code></pre>"},{"location":"examples/full-workflow/#class-method","title":"Class Method","text":"<pre><code>calc._(\n  \"a class method named 'self.from_range' that accepts (low, high) \" \\\n  \"and returns a new StatisticsCalculator initialized with (low..high).to_a\",\n  scope: :class\n)\n\nrange_calc = StatisticsCalculator.from_range(1, 5)\nrange_calc.data  #=&gt; [1, 2, 3, 4, 5]\n</code></pre>"},{"location":"examples/full-workflow/#singleton-method","title":"Singleton Method","text":"<pre><code>calc._(\n  \"a method named 'report' that returns a multi-line summary \" \\\n  \"of count, mean, median, and standard_deviation\",\n  scope: :singleton\n)\n\nputs calc.report\n# Only available on this specific calc instance\nother = StatisticsCalculator.new([1, 2, 3])\nother.respond_to?(:report)  #=&gt; false\n</code></pre>"},{"location":"examples/full-workflow/#generated-files","title":"Generated Files","text":"<p>The lifecycle hook saves each method to the <code>examples/generated/</code> directory:</p> <pre><code>examples/generated/\n  mean_instance.rb\n  median_instance.rb\n  standard_deviation_instance.rb\n  from_range_class.rb\n  report_singleton.rb\n</code></pre>"},{"location":"examples/full-workflow/#source-inspection","title":"Source Inspection","text":"<p>After generation, the source for each method can be retrieved:</p> <pre><code>[:mean, :median, :standard_deviation].each do |name|\n  puts \"--- #{name} ---\"\n  puts calc._source_for(name)\nend\n</code></pre>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Ruby &gt;= 3.2.0</li> <li>An LLM provider (Ollama recommended for local development)</li> </ul>"},{"location":"getting-started/installation/#add-to-your-project","title":"Add to Your Project","text":"<p>Add SelfAgency to your Gemfile:</p> <pre><code>gem \"self_agency\"\n</code></pre> <p>Then install:</p> <pre><code>bundle install\n</code></pre> <p>Or install directly:</p> <pre><code>gem install self_agency\n</code></pre>"},{"location":"getting-started/installation/#dependencies","title":"Dependencies","text":"<p>SelfAgency depends on:</p> Gem Purpose <code>ruby_llm</code> LLM provider communication <code>ruby_llm-template</code> ERB prompt template management <code>method_source</code> Source code retrieval for file-defined methods <p>These are installed automatically when you install the gem.</p>"},{"location":"getting-started/installation/#llm-provider-setup","title":"LLM Provider Setup","text":"<p>SelfAgency uses ruby_llm under the hood, which supports multiple providers. The default configuration targets a local Ollama instance.</p>"},{"location":"getting-started/installation/#ollama-default","title":"Ollama (Default)","text":"<p>Install Ollama and pull a model:</p> <pre><code># Install Ollama (macOS)\nbrew install ollama\n\n# Start the server\nollama serve\n\n# Pull a model\nollama pull qwen3-coder:30b\n</code></pre>"},{"location":"getting-started/installation/#other-providers","title":"Other Providers","text":"<p>Any provider supported by ruby_llm works. Set the <code>provider</code>, <code>model</code>, and <code>api_base</code> in your configuration:</p> <pre><code>SelfAgency.configure do |config|\n  config.provider = :openai\n  config.model    = \"gpt-4o\"\n  config.api_base = \"https://api.openai.com/v1\"\nend\n</code></pre> <p>See Configuration for all options.</p>"},{"location":"getting-started/quick-start/","title":"Quick Start","text":"<p>This guide walks through a complete example from configuration to using generated methods.</p>"},{"location":"getting-started/quick-start/#1-configure-selfagency","title":"1. Configure SelfAgency","text":"<p>Before generating any methods, call <code>SelfAgency.configure</code>:</p> <pre><code>require \"self_agency\"\n\nSelfAgency.configure do |config|\n  config.provider = :ollama\n  config.model    = \"qwen3-coder:30b\"\n  config.api_base = \"http://localhost:11434/v1\"\nend\n</code></pre> <p>Configuration is mandatory. Calling <code>_()</code> before <code>configure</code> raises <code>SelfAgency::Error</code>.</p>"},{"location":"getting-started/quick-start/#2-include-the-module","title":"2. Include the Module","text":"<p>Add <code>include SelfAgency</code> to any class:</p> <pre><code>class Calculator\n  include SelfAgency\nend\n\ncalc = Calculator.new\n</code></pre>"},{"location":"getting-started/quick-start/#3-generate-a-method","title":"3. Generate a Method","text":"<p>Call <code>_()</code> with a natural language description:</p> <pre><code>names = calc._(\"an instance method named 'add' that accepts two integer parameters a and b, and returns their sum\")\n#=&gt; [:add]\n</code></pre> <p><code>_()</code> always returns an Array of Symbol method names.</p>"},{"location":"getting-started/quick-start/#4-use-the-method","title":"4. Use the Method","text":"<p>The generated method is available immediately:</p> <pre><code>calc.add(3, 7)   #=&gt; 10\ncalc.add(-1, 1)  #=&gt; 0\n</code></pre> <p>Instance methods (the default scope) are available on all instances of the class:</p> <pre><code>other = Calculator.new\nother.add(100, 200)  #=&gt; 300\n</code></pre>"},{"location":"getting-started/quick-start/#5-view-the-source","title":"5. View the Source","text":"<p>Inspect what the LLM generated:</p> <pre><code>puts calc._source_for(:add)\n# &gt;&gt; # an instance method named 'add' that accepts two integer\n# &gt;&gt; # parameters a and b, and returns their sum\n# &gt;&gt; def add(a, b)\n# &gt;&gt;   a + b\n# &gt;&gt; end\n</code></pre>"},{"location":"getting-started/quick-start/#6-generate-multiple-methods","title":"6. Generate Multiple Methods","text":"<p>A single <code>_()</code> call can produce several methods:</p> <pre><code>names = calc._(\n  \"create add, subtract, multiply, and divide methods for two integers\"\n)\n#=&gt; [:add, :subtract, :multiply, :divide]\n\ncalc.subtract(10, 3)  #=&gt; 7\ncalc.multiply(4, 5)   #=&gt; 20\ncalc.divide(10, 3)    #=&gt; 3.333...\n</code></pre>"},{"location":"getting-started/quick-start/#next-steps","title":"Next Steps","text":"<ul> <li>Scopes -- Generate singleton and class methods</li> <li>Source Inspection -- View and retrieve generated source</li> <li>Saving Methods -- Persist generated methods to files</li> <li>Configuration -- All configuration options</li> </ul>"},{"location":"guide/configuration/","title":"Configuration","text":"<p>SelfAgency must be configured before generating any methods. Call <code>SelfAgency.configure</code> with a block:</p> <pre><code>SelfAgency.configure do |config|\n  config.provider = :ollama\n  config.model    = \"qwen3-coder:30b\"\n  config.api_base = \"http://localhost:11434/v1\"\nend\n</code></pre>"},{"location":"guide/configuration/#options","title":"Options","text":"Option Type Default Description <code>provider</code> <code>Symbol</code> <code>:ollama</code> RubyLLM provider name <code>model</code> <code>String</code> <code>\"qwen3-coder:30b\"</code> LLM model identifier <code>api_base</code> <code>String</code> <code>\"http://localhost:11434/v1\"</code> Provider API endpoint <code>request_timeout</code> <code>Integer</code> <code>30</code> Request timeout in seconds <code>max_retries</code> <code>Integer</code> <code>1</code> Number of retries on failure <code>retry_interval</code> <code>Float</code> <code>0.5</code> Seconds between retries <code>template_directory</code> <code>String</code> <code>lib/self_agency/prompts</code> Path to ERB prompt templates"},{"location":"guide/configuration/#configuration-is-mandatory","title":"Configuration Is Mandatory","text":"<p>Calling <code>_()</code> before <code>configure</code> raises <code>SelfAgency::Error</code>:</p> <pre><code>SelfAgency.reset!\n\nclass Widget\n  include SelfAgency\nend\n\nWidget.new._(\"a method\")\n#=&gt; SelfAgency::Error: SelfAgency.configure has not been called\n</code></pre>"},{"location":"guide/configuration/#applying-configuration","title":"Applying Configuration","text":"<p><code>SelfAgency.configure</code> delegates to <code>RubyLLM.configure</code> and <code>RubyLLM::Template.configure</code> under the hood:</p> <ul> <li><code>provider</code> + <code>api_base</code> set the provider-specific API base on RubyLLM. The <code>api_base</code> value is assigned to the RubyLLM config key <code>&lt;provider&gt;_api_base</code>. For example, <code>:openai</code> maps to <code>openai_api_base</code>, <code>:ollama</code> maps to <code>ollama_api_base</code>.</li> <li><code>request_timeout</code>, <code>max_retries</code>, and <code>retry_interval</code> map directly to RubyLLM settings</li> <li><code>template_directory</code> is passed to <code>RubyLLM::Template</code></li> </ul>"},{"location":"guide/configuration/#resetting-configuration","title":"Resetting Configuration","text":"<p><code>SelfAgency.reset!</code> restores all defaults and marks the gem as unconfigured:</p> <pre><code>SelfAgency.reset!\n\nSelfAgency.ensure_configured!\n#=&gt; SelfAgency::Error: SelfAgency.configure has not been called\n</code></pre>"},{"location":"guide/configuration/#checking-configuration","title":"Checking Configuration","text":"<p><code>SelfAgency.ensure_configured!</code> raises if <code>configure</code> has not been called:</p> <pre><code>SelfAgency.ensure_configured!  # raises or succeeds silently\n</code></pre>"},{"location":"guide/configuration/#example-custom-timeouts","title":"Example: Custom Timeouts","text":"<p>For complex method generation that takes longer:</p> <pre><code>SelfAgency.configure do |config|\n  config.provider        = :ollama\n  config.model           = \"qwen3-coder:30b\"\n  config.api_base        = \"http://localhost:11434/v1\"\n  config.request_timeout = 120\n  config.max_retries     = 3\n  config.retry_interval  = 1.0\nend\n</code></pre>"},{"location":"guide/configuration/#example-openai","title":"Example: OpenAI","text":"<pre><code>SelfAgency.configure do |config|\n  config.provider = :openai\n  config.model    = \"gpt-4o\"\n  config.api_base = \"https://api.openai.com/v1\"\nend\n</code></pre>"},{"location":"guide/generating-methods/","title":"Generating Methods","text":"<p>The <code>_()</code> method is the core API of SelfAgency. It takes a natural language description and generates one or more Ruby methods at runtime.</p>"},{"location":"guide/generating-methods/#single-method","title":"Single Method","text":"<pre><code>names = calc._(\"an instance method named 'add' that accepts two integer parameters a and b, and returns their sum\")\n#=&gt; [:add]\n\ncalc.add(3, 7)  #=&gt; 10\n</code></pre>"},{"location":"guide/generating-methods/#multiple-methods","title":"Multiple Methods","text":"<p>Describe several methods in one call:</p> <pre><code>names = calc._(\n  \"create four instance methods: \" \\\n  \"'add(a, b)' returns a + b, \" \\\n  \"'subtract(a, b)' returns a - b, \" \\\n  \"'multiply(a, b)' returns a * b, \" \\\n  \"'divide(a, b)' returns a.to_f / b (raises ZeroDivisionError if b is zero)\"\n)\n#=&gt; [:add, :subtract, :multiply, :divide]\n</code></pre> <p><code>_()</code> always returns an Array of Symbol method names, even for a single method.</p>"},{"location":"guide/generating-methods/#return-value","title":"Return Value","text":"<p>The return value is always an <code>Array&lt;Symbol&gt;</code> containing the names of all methods defined by that call:</p> <pre><code>method_names = calc._(\"a method to double a number\")\nmethod_names        #=&gt; [:double]\nmethod_names.class  #=&gt; Array\n</code></pre>"},{"location":"guide/generating-methods/#class-context","title":"Class Context","text":"<p>The LLM receives introspection context about your class when generating methods:</p> <ul> <li>Class name -- So it can reference the correct class</li> <li>Instance variables -- Current instance variables on the calling object</li> <li>Public methods -- Methods defined directly on your class (excludes inherited <code>Object</code> methods)</li> </ul> <p>This means generated methods can work with your class's existing state:</p> <pre><code>class BankAccount\n  include SelfAgency\n\n  attr_reader :owner, :balance\n\n  def initialize(owner, balance)\n    @owner   = owner\n    @balance = balance\n  end\nend\n\naccount = BankAccount.new(\"Alice\", 1000)\naccount._(\n  \"an instance method named 'summary' that returns a string like \" \\\n  \"'Account for &lt;owner&gt;: $&lt;balance&gt;' using the @owner and @balance instance variables\"\n)\n\naccount.summary  #=&gt; \"Account for Alice: $1000\"\n</code></pre>"},{"location":"guide/generating-methods/#method-overrides","title":"Method Overrides","text":"<p>Generating a method with the same name as an existing method overrides it. SelfAgency uses <code>Module#prepend</code>, so the generated method takes priority in Ruby's method resolution order (MRO):</p> <pre><code>class Formatter\n  include SelfAgency\n\n  def greet(name)\n    \"Hello, #{name}\"\n  end\nend\n\nfmt = Formatter.new\nfmt.greet(\"World\")  #=&gt; \"Hello, World\"\n\nfmt._(\n  \"an instance method named 'greet' that accepts a name parameter \" \\\n  \"and returns 'Greetings, &lt;name&gt;! Welcome aboard.'\"\n)\n\nfmt.greet(\"World\")  #=&gt; \"Greetings, World! Welcome aboard.\"\n</code></pre>"},{"location":"guide/generating-methods/#error-handling","title":"Error Handling","text":"<p><code>_()</code> can raise three types of errors:</p> <pre><code>begin\n  calc._(\"a method to do something\")\nrescue SelfAgency::GenerationError =&gt; e\n  # LLM returned nil\nrescue SelfAgency::ValidationError =&gt; e\n  # Code is empty, malformed, or has syntax errors\nrescue SelfAgency::SecurityError =&gt; e\n  # Dangerous pattern detected in generated code\nend\n</code></pre> <p>Or catch all SelfAgency errors at once:</p> <pre><code>begin\n  calc._(\"a method to do something\")\nrescue SelfAgency::Error =&gt; e\n  puts \"Generation failed: #{e.message}\"\nend\n</code></pre> <p>Note</p> <p>LLM communication failures (network errors, timeouts, API errors) are rescued internally and surface as <code>GenerationError</code> with message \"Code generation failed (LLM returned nil)\" or \"Prompt shaping failed (LLM returned nil)\". If generation consistently fails, verify your LLM provider is running and reachable.</p> <p>See Errors for the full error hierarchy.</p>"},{"location":"guide/lifecycle-hooks/","title":"Lifecycle Hooks","text":"<p>SelfAgency provides a lifecycle hook that fires each time a method is generated. Override it in your class to persist, log, or react to generated methods.</p>"},{"location":"guide/lifecycle-hooks/#on_method_generated","title":"<code>on_method_generated</code>","text":"<pre><code>def on_method_generated(method_name, scope, code)\n</code></pre> Parameter Type Description <code>method_name</code> <code>Symbol</code> Name of the generated method <code>scope</code> <code>Symbol</code> <code>:instance</code>, <code>:singleton</code>, or <code>:class</code> <code>code</code> <code>String</code> The generated source code <p>By default, <code>on_method_generated</code> is a no-op. Override it in your class:</p> <pre><code>class PersistentCalculator\n  include SelfAgency\n\n  attr_reader :generation_log\n\n  def initialize\n    @generation_log = []\n  end\n\n  def on_method_generated(method_name, scope, code)\n    @generation_log &lt;&lt; { method_name: method_name, scope: scope, code: code }\n    puts \"[hook] Generated :#{method_name} (scope: #{scope})\"\n  end\nend\n</code></pre>"},{"location":"guide/lifecycle-hooks/#when-it-fires","title":"When It Fires","text":"<p>The hook fires once per method after successful validation and installation. If <code>_()</code> generates multiple methods in a single call, the hook fires for each one:</p> <pre><code>calc = PersistentCalculator.new\n\ncalc._(\"an instance method named 'increment' that returns n + 1\")\n# [hook] Generated :increment (scope: instance)\n\ncalc._(\n  \"two methods: 'min_of(a, b)' returns the smaller, \" \\\n  \"'max_of(a, b)' returns the larger\"\n)\n# [hook] Generated :min_of (scope: instance)\n# [hook] Generated :max_of (scope: instance)\n</code></pre>"},{"location":"guide/lifecycle-hooks/#common-patterns","title":"Common Patterns","text":""},{"location":"guide/lifecycle-hooks/#save-to-files","title":"Save to Files","text":"<pre><code>def on_method_generated(method_name, scope, code)\n  filepath = \"generated/#{method_name}_#{scope}.rb\"\n  File.write(filepath, code)\nend\n</code></pre>"},{"location":"guide/lifecycle-hooks/#log-to-a-database","title":"Log to a Database","text":"<pre><code>def on_method_generated(method_name, scope, code)\n  GeneratedMethod.create!(\n    name: method_name.to_s,\n    scope: scope.to_s,\n    source: code,\n    class_name: self.class.name\n  )\nend\n</code></pre>"},{"location":"guide/lifecycle-hooks/#collect-for-later-inspection","title":"Collect for Later Inspection","text":"<pre><code>def on_method_generated(method_name, scope, code)\n  @generation_log &lt;&lt; { method_name: method_name, scope: scope, code: code }\nend\n</code></pre> <p>This pattern is used in the collaborative robots and autonomous robots examples.</p>"},{"location":"guide/prompt-templates/","title":"Prompt Templates","text":"<p>SelfAgency uses ruby_llm-template for prompt management. The two-stage pipeline (shape and generate) each use a pair of ERB templates.</p>"},{"location":"guide/prompt-templates/#default-template-layout","title":"Default Template Layout","text":"<pre><code>lib/self_agency/prompts/\n  shape/\n    system.txt.erb    # System prompt for the shape stage\n    user.txt.erb      # User prompt for the shape stage\n  generate/\n    system.txt.erb    # System prompt for the generate stage\n    user.txt.erb      # User prompt for the generate stage\n</code></pre>"},{"location":"guide/prompt-templates/#shape-stage-templates","title":"Shape Stage Templates","text":"<p>The shape stage rewrites a casual language description into a precise Ruby method specification.</p> <p><code>shape/system.txt.erb</code> -- Instructs the LLM to act as a prompt engineer, with rules for rewriting descriptions:</p> <ul> <li>State the exact method name (snake_case)</li> <li>State the method signature with parameter names, types, defaults</li> <li>State the return type and value</li> <li>Describe the algorithm step by step</li> <li>Translate vague terms into concrete Ruby operations</li> <li>Output only plain language, no code</li> </ul> <p><code>shape/user.txt.erb</code> -- Provides class context and the user's request:</p> <pre><code>Rewrite the following casual request into a precise Ruby method specification.\n\nClass context:\n- Class name: &lt;%= class_name %&gt;\n- Instance variables: &lt;%= ivars %&gt;\n- Public methods: &lt;%= methods %&gt;\n- Scope: &lt;%= scope_instruction %&gt;\n\nUser request:\n&lt;%= raw_prompt %&gt;\n</code></pre>"},{"location":"guide/prompt-templates/#available-variables-shape","title":"Available Variables (Shape)","text":"Variable Description <code>class_name</code> Name of the including class <code>ivars</code> Comma-separated list of instance variables <code>methods</code> Comma-separated list of public instance methods <code>scope_instruction</code> Human-readable scope description <code>raw_prompt</code> The user's original description"},{"location":"guide/prompt-templates/#generate-stage-templates","title":"Generate Stage Templates","text":"<p>The generate stage produces Ruby code from the shaped specification.</p> <p><code>generate/system.txt.erb</code> -- Instructs the LLM to act as a Ruby code generator:</p> <ul> <li>Return exactly one <code>def method_name ... end</code> block</li> <li>Do not use dangerous methods (<code>system</code>, <code>exec</code>, <code>File</code>, <code>IO</code>, <code>eval</code>, etc.)</li> <li>Do not wrap code in markdown fences</li> <li>The method must be self-contained</li> </ul> <p>Note</p> <p>The template instructs the LLM to return \"exactly one\" method definition. However, when describing multiple methods in a single <code>_()</code> call, some LLMs return multiple <code>def...end</code> blocks despite this instruction. SelfAgency handles this gracefully -- it splits the output into individual method blocks and installs each one separately.</p> <p><code>generate/user.txt.erb</code> -- Passes the shaped specification:</p> <pre><code>&lt;%= shaped_spec %&gt;\n</code></pre>"},{"location":"guide/prompt-templates/#available-variables-generate","title":"Available Variables (Generate)","text":"Variable Description <code>class_name</code> Name of the including class <code>ivars</code> Comma-separated list of instance variables <code>methods</code> Comma-separated list of public instance methods <code>shaped_spec</code> Output from the shape stage"},{"location":"guide/prompt-templates/#custom-templates","title":"Custom Templates","text":""},{"location":"guide/prompt-templates/#why-customize","title":"Why Customize?","text":"<p>The default prompts are tuned for general-purpose code generation, but different providers and models respond best to different prompt styles. You may want to customize templates when:</p> <ul> <li>Switching providers or models -- A prompt that works well with Ollama's Qwen may produce poor results with OpenAI's GPT-4o or Anthropic's Claude. Some models need more explicit instructions; others perform better with fewer constraints. Smaller models may need step-by-step algorithmic guidance that a larger model would find redundant.</li> <li>Domain-specific generation -- If your class operates in a specific domain (financial calculations, data science, text processing), you can add domain rules and conventions directly into the system prompt so every generated method follows them.</li> <li>Code style enforcement -- You may want generated methods to follow your project's conventions: frozen string literals, specific naming patterns, guard clauses, or particular error handling styles.</li> <li>Controlling output format -- Some models wrap output in markdown fences or include chain-of-thought reasoning despite instructions not to. Tailoring the prompt to your model's quirks reduces the sanitization needed.</li> </ul>"},{"location":"guide/prompt-templates/#setup","title":"Setup","text":"<p>Start by copying the default prompts into your project:</p> <pre><code>cp -r $(bundle show self_agency)/lib/self_agency/prompts my_prompts\n</code></pre> <p>Then point SelfAgency at your copy:</p> <pre><code>SelfAgency.configure do |config|\n  config.template_directory = File.expand_path(\"my_prompts\", __dir__)\n  # ...\nend\n</code></pre> <p>Your custom directory must follow the same layout:</p> <pre><code>my_prompts/\n  shape/\n    system.txt.erb\n    user.txt.erb\n  generate/\n    system.txt.erb\n    user.txt.erb\n</code></pre> <p>All ERB variables listed above are available in your custom templates.</p>"},{"location":"guide/prompt-templates/#example-adapting-the-generate-prompt-for-a-different-model","title":"Example: Adapting the Generate Prompt for a Different Model","text":"<p>The default <code>generate/system.txt.erb</code> is concise:</p> <pre><code>You are a Ruby code generator. You MUST respond with ONLY a Ruby method\ndefinition \u2014 nothing else. No explanation, no markdown fences, no comments\noutside the method, no extra text.\n\nContext for the class you are writing a method for:\n- Class name: &lt;%= class_name %&gt;\n- Instance variables: &lt;%= ivars %&gt;\n- Public methods: &lt;%= methods %&gt;\n\nRules:\n- Return exactly one `def method_name ... end` block.\n- Do NOT use system, exec, backticks, File, IO, Kernel, require, load, eval, or send.\n- Do NOT wrap the code in markdown fences.\n- The method must be self-contained.\n</code></pre> <p>A smaller or less instruction-following model might ignore the \"no markdown fences\" rule, or include conversational preamble before the code. You could adapt it with stronger guardrails:</p> <pre><code>TASK: Generate a Ruby method definition.\n\nCRITICAL FORMAT RULES:\n1. Your ENTIRE response must be a single `def ... end` block.\n2. Do NOT output any text before `def` or after `end`.\n3. Do NOT use ``` fences. Do NOT use &lt;think&gt; tags.\n4. Do NOT include comments, explanations, or notes.\n\nIf you output anything other than a method definition, the parse will fail.\n\nClass: &lt;%= class_name %&gt;\nInstance variables: &lt;%= ivars %&gt;\nExisting methods: &lt;%= methods %&gt;\n\nFORBIDDEN constructs (will be rejected):\nsystem, exec, spawn, fork, backticks, File, IO, Kernel, Open3,\nProcess, require, load, eval, send, __send__, remove_method, undef_method\n\nWrite ONLY the def ... end block now.\n</code></pre> <p>This version uses imperative language, repeats the format constraint, and explicitly warns about parse failure -- techniques that help smaller models stay on track.</p>"},{"location":"guide/saving-methods/","title":"Saving Methods","text":"<p><code>_save!</code> writes an object's generated methods as a subclass in a Ruby source file. This lets you capture LLM-generated methods as permanent, version-controlled code.</p>"},{"location":"guide/saving-methods/#basic-usage","title":"Basic Usage","text":"<pre><code>foo = Foo.new\nfoo._(\"an instance method to add two integers\")\nfoo._(\"an instance method to subtract two integers\")\n\nfoo._save!(as: :calculator)\n</code></pre> <p>This writes <code>calculator.rb</code>:</p> <pre><code># frozen_string_literal: true\n\nrequire_relative \"foo\"\n\nclass Calculator &lt; Foo\n  # an instance method to add two integers\n  def add(a, b)\n    a + b\n  end\n\n  # an instance method to subtract two integers\n  def subtract(a, b)\n    a - b\n  end\nend\n</code></pre>"},{"location":"guide/saving-methods/#the-as-parameter","title":"The <code>as:</code> Parameter","text":"<p><code>as:</code> is required. It sets the subclass name and (by default) the output filename. It accepts a String or Symbol.</p> <p>Snake case is automatically converted to CamelCase:</p> <pre><code>foo._save!(as: :weather_analyst)\n# Writes weather_analyst.rb with class WeatherAnalyst &lt; Foo\n\nfoo._save!(as: \"WeatherAnalyst\")\n# Same result\n</code></pre>"},{"location":"guide/saving-methods/#custom-file-path","title":"Custom File Path","text":"<p>Override the default file path with <code>path:</code>:</p> <pre><code>foo._save!(as: :calculator, path: \"lib/calculator.rb\")\n</code></pre>"},{"location":"guide/saving-methods/#require-path","title":"Require Path","text":"<p>The generated file includes a <code>require_relative</code> pointing back to the parent class source file. The path is computed relative to the output file location.</p>"},{"location":"guide/saving-methods/#multiple-instances-different-methods","title":"Multiple Instances, Different Methods","text":"<p>Each instance of a class can have different generated methods. <code>_save!</code> captures only the methods generated on that specific instance:</p> <pre><code>collector = Robot.new(name: \"Collector\")\nanalyst   = Robot.new(name: \"Analyst\")\n\n# Each robot generates different methods via _()\ncollector._save!(as: collector.name)  # collector.rb with class Collector &lt; Robot\nanalyst._save!(as: analyst.name)      # analyst.rb   with class Analyst &lt; Robot\n</code></pre>"},{"location":"guide/saving-methods/#description-comments","title":"Description Comments","text":"<p>Each method in the saved file includes the original natural language description as a comment header, so the intent behind the generated code is preserved.</p>"},{"location":"guide/saving-methods/#errors","title":"Errors","text":"Error Condition <code>ArgumentError</code> <code>as:</code> is not a String or Symbol <code>SelfAgency::Error</code> No generated methods to save <code>SelfAgency::Error</code> Parent class is anonymous (no name)"},{"location":"guide/scopes/","title":"Scopes","text":"<p>SelfAgency supports three scopes for generated methods: <code>:instance</code>, <code>:singleton</code>, and <code>:class</code>. The scope is passed as the <code>scope:</code> keyword argument to <code>_()</code>.</p>"},{"location":"guide/scopes/#instance-scope-default","title":"Instance Scope (Default)","text":"<p>Instance methods are available on all instances of the class. This is the default scope.</p> <pre><code>class Greeter\n  include SelfAgency\nend\n\nalice = Greeter.new\nbob   = Greeter.new\n\nalice._(\"an instance method named 'hello' that returns the string 'Hello, world!'\")\n\nalice.hello  #=&gt; \"Hello, world!\"\nbob.hello    #=&gt; \"Hello, world!\" -- available to all instances\n</code></pre> <p>Internally, SelfAgency creates an anonymous module containing the generated method and uses <code>prepend</code> to add it to the class. This means the method appears on all current and future instances.</p>"},{"location":"guide/scopes/#singleton-scope","title":"Singleton Scope","text":"<p>Singleton methods are available on only one specific instance. Other instances of the same class do not have the method.</p> <pre><code>alice._(\"a method named 'secret' that returns 'Alice only'\", scope: :singleton)\n\nalice.secret                    #=&gt; \"Alice only\"\nbob.respond_to?(:secret)       #=&gt; false\n</code></pre> <p>Internally, singleton-scoped methods are prepended to the instance's singleton class.</p>"},{"location":"guide/scopes/#class-scope","title":"Class Scope","text":"<p>Class methods are available on the class itself, not on instances.</p> <pre><code>alice._(\"a class method named 'self.class_greeting' that returns 'Greetings from Greeter'\", scope: :class)\n\nGreeter.class_greeting  #=&gt; \"Greetings from Greeter\"\n</code></pre> <p>Note</p> <p>For class methods, the LLM generates <code>def self.method_name</code>. SelfAgency strips the <code>self.</code> prefix before evaluating, since it prepends the method to the class's singleton class.</p>"},{"location":"guide/scopes/#scope-comparison","title":"Scope Comparison","text":"Scope Keyword Available On Mechanism Instance <code>scope: :instance</code> All instances of the class <code>self.class.prepend(module)</code> Singleton <code>scope: :singleton</code> One specific instance <code>singleton_class.prepend(module)</code> Class <code>scope: :class</code> The class itself <code>self.class.singleton_class.prepend(module)</code>"},{"location":"guide/scopes/#combining-scopes","title":"Combining Scopes","text":"<p>You can mix scopes freely on the same class:</p> <pre><code>calc = StatisticsCalculator.new([10, 20, 30])\n\n# Instance methods -- available to all instances\ncalc._(\"an instance method named 'mean' ...\")\n\n# Class method -- available on StatisticsCalculator itself\ncalc._(\"a class method named 'self.from_range' ...\", scope: :class)\n\n# Singleton method -- available only on this calc instance\ncalc._(\"a method named 'report' ...\", scope: :singleton)\n</code></pre>"},{"location":"guide/source-inspection/","title":"Source Inspection","text":"<p><code>_source_for</code> returns the source code for any method -- both LLM-generated and file-defined methods.</p>"},{"location":"guide/source-inspection/#instance-level-inspection","title":"Instance-Level Inspection","text":"<p>Call <code>_source_for</code> on an instance to retrieve source code:</p> <pre><code>class MathHelper\n  include SelfAgency\n\n  # Multiplies a number by two.\n  def double(n)\n    n * 2\n  end\nend\n\nhelper = MathHelper.new\nhelper._(\"an instance method named 'square' that accepts an integer n and returns n * n\")\n</code></pre> <p>For LLM-generated methods, <code>_source_for</code> returns the code with the original description as a comment header:</p> <pre><code>puts helper._source_for(:square)\n# &gt;&gt; # an instance method named 'square' that accepts an integer n and returns n * n\n# &gt;&gt; def square(n)\n# &gt;&gt;   n * n\n# &gt;&gt; end\n</code></pre>"},{"location":"guide/source-inspection/#class-level-inspection","title":"Class-Level Inspection","text":"<p><code>_source_for</code> is also available as a class method:</p> <pre><code>puts MathHelper._source_for(:square)\n# &gt;&gt; # an instance method named 'square' that accepts an integer n and returns n * n\n# &gt;&gt; def square(n)\n# &gt;&gt;   n * n\n# &gt;&gt; end\n</code></pre> <p>Both instance and class level lookups return the same source for LLM-generated methods.</p>"},{"location":"guide/source-inspection/#file-defined-methods","title":"File-Defined Methods","text":"<p>For methods defined in source files (not generated by the LLM), <code>_source_for</code> falls back to the <code>method_source</code> gem. It includes any comments directly above the method definition:</p> <pre><code>puts helper._source_for(:double)\n# &gt;&gt; # Multiplies a number by two.\n# &gt;&gt; def double(n)\n# &gt;&gt;   n * 2\n# &gt;&gt; end\n</code></pre>"},{"location":"guide/source-inspection/#unknown-methods","title":"Unknown Methods","text":"<p>If a method doesn't exist or its source is unavailable, <code>_source_for</code> returns <code>nil</code>:</p> <pre><code>helper._source_for(:nonexistent)  #=&gt; nil\n</code></pre>"},{"location":"guide/source-inspection/#how-it-works","title":"How It Works","text":"<p><code>_source_for</code> checks two sources in order:</p> <ol> <li>LLM-generated source -- Stored in an internal hash when <code>_()</code> creates the method</li> <li>File source -- Falls back to <code>method_source</code> gem for methods defined in <code>.rb</code> files</li> </ol> <p>If both lookups fail (method doesn't exist or source file can't be located), <code>nil</code> is returned.</p>"}]}